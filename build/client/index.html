<script src="/socket.io/socket.io.js"></script>
<script>
  var socket = io.connect('http://localhost:6063');
  var pin;
  var connected = false;
  
  socket.on('connect', function () {
        console.log('connected');
        document.getElementById('ico-conn').style.visibility = '';
        connected = true;
  });
  
  socket.on('pin', function (data) {
        console.log(data);
        if (pin) { // resetting our pin from server?
            document.getElementById('connect?').style.display = '';
        }
        
        pin = data.pin;
        document.getElementById('pin_display').textContent = pin;
  });
    
  socket.on('disconnect', function () {
        console.log('disconnected');
        document.getElementById('ico-good').style.visibility = 'hidden';
        document.getElementById('ico-conn').style.visibility = 'hidden';
        document.getElementById('input').style.visibility = 'hidden';
        document.getElementById('data').style.visibility = 'hidden';
        connected = false;
  });
   
  socket.on('bc', function (data) {
        console.log(data);
        if (data.conn) {
            document.getElementById('connector').style.display = 'none';
            document.getElementById('connect?').style.display = 'none';
            document.getElementById('ico-good').style.visibility = '';
            
            document.getElementById('input').style.visibility = '';
        }
  });
  
  socket.on('err', function (e) {
        console.log('err: ',e);
        if (e.pin) {
            console.log('pin error')
        }
  });
  
  var data_list = [];
  socket.on('data', function (data) {
        console.log('data: ',data);
        
        if (data.text) {
            data_list.pop();
            data_list.unshift(data.text);
            
            document.getElementById('data').style.visibility = '';
            
            var list = document.getElementById('data_list');
            data_list.forEach(function (el) {
                list.childNodes[i].innerHTML = el;
            });
        }
        else { console.log('unsupported data') }
  });
  
  function connect_show () {
      document.getElementById('connect?').style.display = 'none';
      document.getElementById('connector').style.visibility = '';
      document.getElementById('pin_connect').value = '';
  }
  
  function connect_begin (inp) {
      if (!inp) {
            console.log('begin!');
            socket.emit('pin', { pin: pin });
      }
      else {
          var p = document.getElementById(inp).value;
          var p = parseInt(p);
          if (typeof p === 'number') {
            console.log('begin!');
            socket.emit('pin', { pin: p });
          }
      }
  }
  
  function send_data (inp) {
      if (!connected) { console.log('not connected'); return }
      
      var data = document.getElementById(inp).value;
      socket.emit('data', {text:data});
      
      document.getElementById(inp).value = '';
      document.getElementById('input_send').style.visibility = 'hidden';
      
      console.log('sent',data)
  }
</script>

<div>
    <span id='ico-good' style="font-family:Wingdings;visibility:hidden">&#x270c;</span>
    <span id='ico-conn' style="font-family:Wingdings;visibility:hidden">&#x27b0;</span> 
    <span id='ico-info' style="font-family:Wingdings" title="source (currently private)">
        <a href="https://gitlab.com/chrisfgill/handsal/" target="blank">&#x1F419;</a>
    </span>
</div>

<div><span id='pin_display'></span></div>

<div id='connect?'>
    <a href="#connect_show" onclick="connect_show()">connect?</a>
</div>

<div id='connector' style='visibility:hidden'>
    <input id='pin_connect' type='text'/>
    <br>
    <a href="#connect" onclick="connect_begin('pin_connect')">connect</a>
    <br>
    <a href="#connect" onclick="connect_begin(null)">connect loopback</a>
</div>

<div id='input' style='visibility:hidden'>
    <textarea id='input_text' 
        oninput="document.getElementById('input_send').style.visibility = '';"></textarea>
    <br>
    <a id='input_send' style='visibility:hidden' 
        href="#" onclick="send_data('input_text')">send</a>
</div>

<div id='data' style='visibility:hidden'>
    <l id='data_list'>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
    </l>
</div>